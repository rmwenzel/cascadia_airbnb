<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Analysis and Modeling &middot; Cascadia Airbnb
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/cascadia_airbnb/public/css/poole.css">
  <link rel="stylesheet" href="/cascadia_airbnb/public/css/syntax.css">
  <link rel="stylesheet" href="/cascadia_airbnb/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/cascadia_airbnb/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/cascadia_airbnb/public/favicon.ico">
  --->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!--- KaTeX --->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
      onload="renderMathInElement(document.body);"></script>
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">

  <nav class="sidebar-nav">

    <a class="sidebar-nav-item" href="/cascadia_airbnb/process/">Data wrangling</a>
    <a class="sidebar-nav-item active" href="/cascadia_airbnb/explore/">Analysis and Modeling</a>

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/cascadia_airbnb/" title="Home">Cascadia Airbnb</a>
            <small>Analysis of AirBnb listings in Portland, Seattle, and Vancouver.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="page">
  <h1 class="page-title">Analysis and Modeling</h1>
  	
<p>In this notebook, we explore answers to some questions and discuss our findings.</p>

<ul>
  <li><a href="#how-does-listing-price-relate-to-location">How does listing price relate to location?</a>
    <ul>
      <li><a href="#how-do-listings-prices-of-compare-across-each-of-the-three-cities">How do listings prices of compare across each of the three cities?</a></li>
      <li><a href="#which-neighborhoods-have-the-highest-and-lowest-priced-listings">Which neighborhoods have the highest and lowest priced listings?</a></li>
      <li><a href="#conclusions1">Conclusions</a></li>
    </ul>
  </li>
  <li><a href="#how-does-listing-price-change-over-time">How does listing price change over time?</a>
    <ul>
      <li><a href="#what-trends-in-price-can-we-identify-across-all-three-cities">What trends in price can we identify across all three cities?</a></li>
      <li><a href="#what-trends-in-price-can-we-identify-within-cities">What trends in price can we identify within cities?</a></li>
      <li><a href="#conclusions2">Conclusions</a></li>
    </ul>
  </li>
  <li><a href="#how-does-overall-guest-satisfaction-relate-to-location">How does overall guest satisfaction relate to location?</a>
    <ul>
      <li><a href="#how-does-guest-satisfaction-compare-across-each-of-the-three-cities">How does guest satisfaction compare across each of the three cities?</a></li>
      <li><a href="#which-neighborhoods-have-the-highest-and-lowest-guest-satisfaction">Which neighborhoods have the highest and lowest guest satisfaction?</a></li>
      <li><a href="#how-does-the-price-of-listings-in-a-neighbourhood-relate-to-guest-satisfaction">How does the price of listings in a neighbourhood relate to guest satisfaction?</a></li>
      <li><a href="#conclusions3">Conclusions</a></li>
    </ul>
  </li>
  <li><a href="#what-are-the-most-important-listing-features-affecting-guest-satisfaction">What are the most important listing features affecting guest satisfaction?</a>
    <ul>
      <li><a href="#getting-features">Getting features</a></li>
      <li><a href="#exploring-features">Exploring features</a></li>
      <li><a href="#exploring-features-vs-response">Exploring features vs. response</a></li>
      <li><a href="#prediction">Prediction</a>
        <ul>
          <li><a href="#scikit-learn-regressors-on-original-features"><code class="language-plaintext highlighter-rouge">scikit-learn</code> regressors on original features</a></li>
          <li><a href="#xgboost-regressors-on-original-features"><code class="language-plaintext highlighter-rouge">xgboost</code> regressors on original features</a></li>
          <li><a href="#scikit-learn-and-xgboost-regressors-on-transformed-quantitative-features"><code class="language-plaintext highlighter-rouge">scikit-learn</code> and <code class="language-plaintext highlighter-rouge">xgboost</code> regressors on transformed quantitative features</a></li>
        </ul>
      </li>
      <li><a href="#evaluation">Evaluation</a></li>
      <li><a href="#interpretation">Interpretation</a></li>
      <li><a href="#model-improvement">Model Improvement</a></li>
      <li><a href="#conclusions4">Conclusions</a></li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># standard imports
</span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="c1"># other imports
</span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="n">ss</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">descartes</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="c1"># estimators
</span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span><span class="p">,</span> <span class="n">XGBRFRegressor</span>

<span class="c1"># settings
</span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">'darkgrid'</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="nb">FutureWarning</span><span class="p">)</span>
</code></pre></div></div>

<p>We’ll load the cleaned data sets (created in the notebook <a href="./wrangling.ipynb">wrangling.ipynb</a> or by running the script <code class="language-plaintext highlighter-rouge">wrangle.py</code>)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s">'data/listings.h5'</span><span class="p">)</span>
<span class="n">listings_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>id</th>
      <th>accommodates</th>
      <th>amen_24_hour_checkin</th>
      <th>amen_air_conditioning</th>
      <th>amen_bathtub</th>
      <th>amen_bbq_grill</th>
      <th>amen_bed_linens</th>
      <th>amen_cable_tv</th>
      <th>amen_carbon_monoxide_detector</th>
      <th>amen_childrens_books_and_toys</th>
      <th>...</th>
      <th>review_scores_accuracy</th>
      <th>review_scores_checkin</th>
      <th>review_scores_cleanliness</th>
      <th>review_scores_communication</th>
      <th>review_scores_location</th>
      <th>review_scores_rating</th>
      <th>review_scores_value</th>
      <th>reviews_per_month</th>
      <th>room_type</th>
      <th>security_deposit</th>
    </tr>
    <tr>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">seattle</th>
      <th>0</th>
      <td>2318</td>
      <td>9</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>100</td>
      <td>10</td>
      <td>0.23</td>
      <td>Entire home/apt</td>
      <td>500.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6606</td>
      <td>2</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>9</td>
      <td>10</td>
      <td>9</td>
      <td>10</td>
      <td>10</td>
      <td>92</td>
      <td>9</td>
      <td>1.16</td>
      <td>Entire home/apt</td>
      <td>200.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9419</td>
      <td>2</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>93</td>
      <td>10</td>
      <td>1.27</td>
      <td>Private room</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9460</td>
      <td>2</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>98</td>
      <td>10</td>
      <td>3.63</td>
      <td>Private room</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9531</td>
      <td>4</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>100</td>
      <td>10</td>
      <td>0.40</td>
      <td>Entire home/apt</td>
      <td>300.0</td>
    </tr>
  </tbody>
</table>
  <p>5 rows × 98 columns</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listings_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 15983 entries, ('seattle', 0) to ('vancouver', 6174)
Data columns (total 98 columns):
 #   Column                                        Non-Null Count  Dtype         
---  ------                                        --------------  -----         
 0   id                                            15983 non-null  int64         
 1   accommodates                                  15983 non-null  int64         
 2   amen_24_hour_checkin                          15983 non-null  bool          
 3   amen_air_conditioning                         15983 non-null  bool          
 4   amen_bathtub                                  15983 non-null  bool          
 5   amen_bbq_grill                                15983 non-null  bool          
 6   amen_bed_linens                               15983 non-null  bool          
 7   amen_cable_tv                                 15983 non-null  bool          
 8   amen_carbon_monoxide_detector                 15983 non-null  bool          
 9   amen_childrens_books_and_toys                 15983 non-null  bool          
 10  amen_coffee_maker                             15983 non-null  bool          
 11  amen_cooking_basics                           15983 non-null  bool          
 12  amen_dishes_and_silverware                    15983 non-null  bool          
 13  amen_dishwasher                               15983 non-null  bool          
 14  amen_dryer                                    15983 non-null  bool          
 15  amen_elevator                                 15983 non-null  bool          
 16  amen_extra_pillows_and_blankets               15983 non-null  bool          
 17  amen_family/kid_friendly                      15983 non-null  bool          
 18  amen_fire_extinguisher                        15983 non-null  bool          
 19  amen_first_aid_kit                            15983 non-null  bool          
 20  amen_free_parking_on_premises                 15983 non-null  bool          
 21  amen_free_street_parking                      15983 non-null  bool          
 22  amen_garden_or_backyard                       15983 non-null  bool          
 23  amen_gym                                      15983 non-null  bool          
 24  amen_hair_dryer                               15983 non-null  bool          
 25  amen_hot_water                                15983 non-null  bool          
 26  amen_indoor_fireplace                         15983 non-null  bool          
 27  amen_internet                                 15983 non-null  bool          
 28  amen_iron                                     15983 non-null  bool          
 29  amen_keypad                                   15983 non-null  bool          
 30  amen_kitchen                                  15983 non-null  bool          
 31  amen_laptop_friendly_workspace                15983 non-null  bool          
 32  amen_lock_on_bedroom_door                     15983 non-null  bool          
 33  amen_lockbox                                  15983 non-null  bool          
 34  amen_long_term_stays_allowed                  15983 non-null  bool          
 35  amen_luggage_dropoff_allowed                  15983 non-null  bool          
 36  amen_microwave                                15983 non-null  bool          
 37  amen_oven                                     15983 non-null  bool          
 38  amen_pack-n-play_travel_crib                  15983 non-null  bool          
 39  amen_patio_or_balcony                         15983 non-null  bool          
 40  amen_pets_allowed                             15983 non-null  bool          
 41  amen_pets_live_on_this_property               15983 non-null  bool          
 42  amen_private_entrance                         15983 non-null  bool          
 43  amen_private_living_room                      15983 non-null  bool          
 44  amen_refrigerator                             15983 non-null  bool          
 45  amen_safety_card                              15983 non-null  bool          
 46  amen_self_check-in                            15983 non-null  bool          
 47  amen_single_level_home                        15983 non-null  bool          
 48  amen_stove                                    15983 non-null  bool          
 49  amen_tv                                       15983 non-null  bool          
 50  amen_washer                                   15983 non-null  bool          
 51  availability_30                               15983 non-null  int64         
 52  availability_365                              15983 non-null  int64         
 53  availability_60                               15983 non-null  int64         
 54  availability_90                               15983 non-null  int64         
 55  bathrooms                                     15983 non-null  float64       
 56  bed_type                                      15983 non-null  category      
 57  bedrooms                                      15983 non-null  int64         
 58  beds                                          15983 non-null  int64         
 59  calculated_host_listings_count                15983 non-null  int64         
 60  calculated_host_listings_count_entire_homes   15983 non-null  int64         
 61  calculated_host_listings_count_private_rooms  15983 non-null  int64         
 62  calculated_host_listings_count_shared_rooms   15983 non-null  int64         
 63  cancellation_policy                           15983 non-null  category      
 64  cleaning_fee                                  15983 non-null  float64       
 65  extra_people                                  15983 non-null  float64       
 66  guests_included                               15983 non-null  int64         
 67  host_acceptance_rate                          15983 non-null  float64       
 68  host_id                                       15983 non-null  int64         
 69  host_identity_verified                        15983 non-null  bool          
 70  host_is_superhost                             15983 non-null  bool          
 71  host_response_rate                            15983 non-null  float64       
 72  host_response_time                            15983 non-null  category      
 73  host_since                                    15983 non-null  datetime64[ns]
 74  instant_bookable                              15983 non-null  bool          
 75  is_business_travel_ready                      15983 non-null  bool          
 76  latitude                                      15983 non-null  float64       
 77  longitude                                     15983 non-null  float64       
 78  maximum_nights                                15983 non-null  int64         
 79  minimum_nights                                15983 non-null  int64         
 80  neighbourhood_cleansed                        15983 non-null  category      
 81  num_amenities                                 15983 non-null  int64         
 82  number_of_reviews                             15983 non-null  int64         
 83  price                                         15983 non-null  float64       
 84  property_type                                 15983 non-null  category      
 85  require_guest_phone_verification              15983 non-null  bool          
 86  require_guest_profile_picture                 15983 non-null  bool          
 87  requires_license                              15983 non-null  bool          
 88  review_scores_accuracy                        15983 non-null  int64         
 89  review_scores_checkin                         15983 non-null  int64         
 90  review_scores_cleanliness                     15983 non-null  int64         
 91  review_scores_communication                   15983 non-null  int64         
 92  review_scores_location                        15983 non-null  int64         
 93  review_scores_rating                          15983 non-null  int64         
 94  review_scores_value                           15983 non-null  int64         
 95  reviews_per_month                             15983 non-null  float64       
 96  room_type                                     15983 non-null  category      
 97  security_deposit                              15983 non-null  float64       
dtypes: bool(56), category(6), datetime64[ns](1), float64(10), int64(25)
memory usage: 5.5+ MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">calendar_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s">'data/calendar.h5'</span><span class="p">)</span>
<span class="n">calendar_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>listing_id</th>
      <th>available</th>
      <th>date</th>
      <th>maximum_nights</th>
      <th>minimum_nights</th>
      <th>price</th>
    </tr>
    <tr>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">seattle</th>
      <th>0</th>
      <td>788146</td>
      <td>False</td>
      <td>2020-02-22</td>
      <td>180.0</td>
      <td>30.0</td>
      <td>68.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>340706</td>
      <td>True</td>
      <td>2020-02-22</td>
      <td>60.0</td>
      <td>2.0</td>
      <td>90.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>340706</td>
      <td>True</td>
      <td>2020-02-23</td>
      <td>60.0</td>
      <td>2.0</td>
      <td>90.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>340706</td>
      <td>True</td>
      <td>2020-02-24</td>
      <td>60.0</td>
      <td>2.0</td>
      <td>90.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>340706</td>
      <td>True</td>
      <td>2020-02-25</td>
      <td>60.0</td>
      <td>2.0</td>
      <td>90.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">calendar_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 6586070 entries, ('seattle', 0) to ('vancouver', 2265188)
Data columns (total 6 columns):
 #   Column          Dtype         
---  ------          -----         
 0   listing_id      int64         
 1   available       bool          
 2   date            datetime64[ns]
 3   maximum_nights  float64       
 4   minimum_nights  float64       
 5   price           float64       
dtypes: bool(1), datetime64[ns](1), float64(3), int64(1)
memory usage: 309.9+ MB
</code></pre></div></div>

<p>All prices are in USD to enable comparison.</p>

<h2 id="how-does-listing-price-relate-to-location">How does listing price relate to location?</h2>

<p>All prices are in USD to enable comparison.</p>

<p>Before exploring these questions, let’s inspect price a little more carefully</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listings_df</span><span class="p">[</span><span class="s">'price'</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>count    15983.000000
mean       137.886442
std        170.924443
min          0.000000
25%         70.000000
50%        100.000000
75%        152.000000
max       9896.000000
Name: price, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">listings_df</span><span class="p">[</span><span class="s">'price'</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x11a32b100&gt;
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_14_1.png" alt="png" /></p>

<p>This is an extremely skewed distribution – and some of these values of price might be problematic.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># listings with zero price
</span><span class="n">listings_df</span><span class="p">[</span><span class="n">listings_df</span><span class="p">[</span><span class="s">'price'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>id</th>
      <th>accommodates</th>
      <th>amen_24_hour_checkin</th>
      <th>amen_air_conditioning</th>
      <th>amen_bathtub</th>
      <th>amen_bbq_grill</th>
      <th>amen_bed_linens</th>
      <th>amen_cable_tv</th>
      <th>amen_carbon_monoxide_detector</th>
      <th>amen_childrens_books_and_toys</th>
      <th>...</th>
      <th>review_scores_accuracy</th>
      <th>review_scores_checkin</th>
      <th>review_scores_cleanliness</th>
      <th>review_scores_communication</th>
      <th>review_scores_location</th>
      <th>review_scores_rating</th>
      <th>review_scores_value</th>
      <th>reviews_per_month</th>
      <th>room_type</th>
      <th>security_deposit</th>
    </tr>
    <tr>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">seattle</th>
      <th>2866</th>
      <td>18670293</td>
      <td>2</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>100</td>
      <td>10</td>
      <td>0.18</td>
      <td>Entire home/apt</td>
      <td>1000.0</td>
    </tr>
    <tr>
      <th>2975</th>
      <td>19293242</td>
      <td>6</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>9</td>
      <td>10</td>
      <td>9</td>
      <td>92</td>
      <td>9</td>
      <td>0.39</td>
      <td>Entire home/apt</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">portland</th>
      <th>2101</th>
      <td>20477753</td>
      <td>2</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>99</td>
      <td>10</td>
      <td>6.90</td>
      <td>Entire home/apt</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>4376</th>
      <td>40187265</td>
      <td>3</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>9</td>
      <td>10</td>
      <td>9</td>
      <td>10</td>
      <td>9</td>
      <td>94</td>
      <td>9</td>
      <td>3.50</td>
      <td>Entire home/apt</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
  <p>4 rows × 98 columns</p>
</div>

<p>Given there are only 4 listings with zero price, we’ll drop these</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listings_df</span> <span class="o">=</span> <span class="n">listings_df</span><span class="p">[</span><span class="n">listings_df</span><span class="p">[</span><span class="s">'price'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<p>And now we can look at the distribution of the natural logarithm of price</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">listings_df</span><span class="p">[</span><span class="s">'price'</span><span class="p">]),</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'log_price'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_20_0.png" alt="png" /></p>

<p>Price appears approximately lognormal.</p>

<h3 id="how-do-listings-prices-of-compare-across-each-of-the-three-cities">How do listings prices of compare across each of the three cities?</h3>

<p>First we’d like to look at differences in listing prices between cities. Given how peaked/skewed the distribution of price is we’ll look at logarithm of price</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># boxen plots of log of price by city
</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxenplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'city'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'price'</span><span class="p">]),</span> <span class="n">orient</span><span class="o">=</span><span class="s">'h'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Logarithm of Listing Price by City'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_24_0.png" alt="png" /></p>

<p>The distributions appear quite similar, with some notable outliers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># summary statistics of price
</span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'price'</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'mean'</span><span class="p">,</span> <span class="s">'std'</span><span class="p">])</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s">'median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'price'</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s">'mad'</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'price'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'median'</span><span class="p">)</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>median</th>
      <th>mad</th>
    </tr>
    <tr>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>portland</th>
      <td>4129.0</td>
      <td>10.0</td>
      <td>66.0</td>
      <td>90.0</td>
      <td>130.0</td>
      <td>8400.0</td>
      <td>90.0</td>
      <td>44.4780</td>
    </tr>
    <tr>
      <th>vancouver</th>
      <td>5320.0</td>
      <td>10.0</td>
      <td>63.0</td>
      <td>95.0</td>
      <td>152.0</td>
      <td>9896.0</td>
      <td>95.0</td>
      <td>56.3388</td>
    </tr>
    <tr>
      <th>seattle</th>
      <td>6530.0</td>
      <td>10.0</td>
      <td>80.0</td>
      <td>115.0</td>
      <td>180.0</td>
      <td>2000.0</td>
      <td>115.0</td>
      <td>65.2344</td>
    </tr>
  </tbody>
</table>
</div>

<p>Here we’ve used the median as a measure of central tendency, and <a href="https://en.wikipedia.org/wiki/Median_absolute_deviation">median absolute devation (mad)</a> as a measure of dispersion due to the skewness of price and presence of outliers.</p>

<p>We’ve sorted by median price but most of the other summary statistics are in the same order. There seems to be a ranking here, namely Portland &lt;  Seattle &lt; Vancouver from lowest to highest.</p>

<h3 id="which-neighborhoods-have-the-highest-and-lowest-priced-listings">Which neighborhoods have the highest and lowest priced listings?</h3>

<p>To address this question, we’ll first create a <a href="https://geopandas.org/index.html">geopandas</a> <code class="language-plaintext highlighter-rouge">GeoDataFrame</code> with median and median absolute deviation of price for all cities and neighborhoods. We’ll also include a count of listings. This geodataframe will also contain neighbourhood geodata so we can make use of its plotting methods.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_city_nb_gdf</span><span class="p">(</span><span class="n">listings_df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">num_listings</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_reviews</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">"""GeoDataFrame of median and mad of column grouped by city and neighborhood."""</span>
    <span class="c1"># load city neighbourhood geodata
</span>    <span class="n">port_nb</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">'data/portland_neighbourhoods.geojson'</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">'neighbourhood'</span><span class="p">])</span>
    <span class="n">sea_nb</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">'data/seattle_neighbourhoods.geojson'</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">'neighbourhood'</span><span class="p">])</span>
    <span class="n">van_nb</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">'data/vancouver_neighbourhoods.geojson'</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">'neighbourhood'</span><span class="p">])</span>
    
    <span class="c1"># create city geodataframe with neighbourhood geodata
</span>    <span class="n">city_nb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">port_nb</span><span class="p">,</span> <span class="n">sea_nb</span><span class="p">,</span> <span class="n">van_nb</span><span class="p">],</span> 
                        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">'portland'</span><span class="p">,</span> <span class="s">'seattle'</span><span class="p">,</span> <span class="s">'vancouver'</span><span class="p">],</span>
                        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'city'</span><span class="p">,</span> <span class="s">'neighbourhood'</span><span class="p">])</span>
    <span class="n">city_nb</span> <span class="o">=</span> <span class="n">city_nb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'neighbourhood_group'</span><span class="p">])</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s">'init'</span><span class="p">:</span> <span class="s">'epsg:4326'</span><span class="p">}</span>
    <span class="n">city_nb_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">city_nb</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
    
    <span class="c1"># get median and absolute value of columns grouped by neighborhood
</span>    <span class="n">gpby</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">,</span> <span class="s">'neighbourhood_cleansed'</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s">'_median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpby</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s">'_mad'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpby</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">)</span>
    
    <span class="c1"># add number of reviews and listings
</span>    <span class="k">if</span> <span class="n">num_listings</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'num_listings'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpby</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">num_reviews</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'num_reviews'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpby</span><span class="p">[</span><span class="s">'number_of_reviews'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    
    <span class="n">city_nb_gdf</span> <span class="o">=</span> <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'inner'</span><span class="p">,</span> 
                                    <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1"># drop duplicates due to slight differences in geodata
</span>    <span class="n">city_nb_gdf</span> <span class="o">=</span> <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
    <span class="c1"># drop certain duplicates by hand that won't response to above method if needed
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'portland'</span><span class="p">,</span> <span class="s">'Ardenwald-Johnson Creek'</span><span class="p">),</span> <span class="p">(</span><span class="s">'vancouver'</span><span class="p">,</span> <span class="s">'Strathcona'</span><span class="p">)]</span>
        <span class="n">city_nb_gdf</span> <span class="o">=</span> <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">return</span> <span class="n">city_nb_gdf</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">city_nb_price_gdf</span> <span class="o">=</span> <span class="n">get_city_nb_gdf</span><span class="p">(</span><span class="n">listings_df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s">'price'</span><span class="p">],</span> <span class="n">num_listings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>geometry</th>
      <th>price_median</th>
      <th>price_mad</th>
      <th>num_listings</th>
    </tr>
    <tr>
      <th>city</th>
      <th>neighbourhood</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">portland</th>
      <th>Alameda</th>
      <td>MULTIPOLYGON Z (((-122.64194 45.55542 0.00000,...</td>
      <td>89.5</td>
      <td>40.0302</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>Arbor Lodge</th>
      <td>MULTIPOLYGON Z (((-122.67858 45.57721 0.00000,...</td>
      <td>85.0</td>
      <td>31.1346</td>
      <td>71.0</td>
    </tr>
    <tr>
      <th>Argay</th>
      <td>MULTIPOLYGON Z (((-122.51026 45.56615 0.00000,...</td>
      <td>70.0</td>
      <td>45.9606</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>Arlington Heights</th>
      <td>MULTIPOLYGON Z (((-122.70194 45.52415 0.00000,...</td>
      <td>100.0</td>
      <td>37.0650</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Arnold Creek</th>
      <td>MULTIPOLYGON Z (((-122.69870 45.43255 0.00000,...</td>
      <td>75.0</td>
      <td>38.5476</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Next we’ll plot the median prices by neighborhood.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>  <span class="n">cmap</span><span class="o">=</span><span class="s">'Blues'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="s">"""Plot column over n"""</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median price of Airbnb Listings for Portland neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'portland'</span><span class="p">],</span> <span class="s">'price_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Blues_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_34_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median price of Airbnb Listings for Seattle neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'seattle'</span><span class="p">],</span> <span class="s">'price_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Oranges_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_35_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median price of Airbnb Listings for Vancouver neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'vancouver'</span><span class="p">],</span> <span class="s">'price_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Greens_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_36_0.png" alt="png" /></p>

<p>All cities seem to show higher prices in some neighbourhoods downtown, and lower prices in neighourhoods which are further away (which is not too suprising).</p>

<p>We want to be careful however in drawing conclusions here – it’s important to look see if any neighbourhoods have a small number of listings which might make inference problematic (small sample size).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># neighbourhoods with less than 10 listings
</span><span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'num_listings &lt; 10'</span><span class="p">)[</span><span class="s">'num_listings'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>city      neighbourhood      
portland  Argay                  5.0
          Arlington Heights      7.0
          Arnold Creek           5.0
          Collins View           7.0
          Crestwood              3.0
          East Columbia          3.0
          Far Southwest          6.0
          Forest Park            3.0
          Glenfair               3.0
          Hayden Island          4.0
          Hollywood              5.0
          Linnton                3.0
          Lloyd District         6.0
          Maplewood              8.0
          Markham                3.0
          Marshall Park          4.0
          Northwest Heights      7.0
          Pleasant Valley        7.0
          Russell                2.0
          Sumner                 6.0
          Sunderland             3.0
          Sylvan-Highlands       7.0
          Woodland Park          1.0
seattle   Harbor Island          1.0
          Holly Park             8.0
          Industrial District    2.0
          Industrial District    2.0
          Industrial District    2.0
          Industrial District    2.0
          South Park             9.0
Name: num_listings, dtype: float64
</code></pre></div></div>

<p>Now focusing on neighbourhoods with more than 10 listings, we’ll plot the median price so we can look at rankings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">city_nb_cat_plot</span><span class="p">(</span><span class="n">city_nb_gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> 
                     <span class="n">err_col</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">city_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">'portland'</span><span class="p">,</span> <span class="s">'seattle'</span><span class="p">,</span> <span class="s">'vancouver'</span><span class="p">]):</span>

        <span class="c1"># inputs for bar plot if error column is passed
</span>        <span class="k">if</span> <span class="n">err_col</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">city_name</span><span class="p">][[</span><span class="n">col</span><span class="p">,</span> <span class="n">err_col</span><span class="p">]]</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'neighbourhood'</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">err_col</span><span class="p">]</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># inputs for point plot
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">city_nb_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">city_name</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'neighbourhood'</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># bar plot
</span>        <span class="k">if</span> <span class="n">kind</span><span class="o">==</span><span class="s">'bar'</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">city_name</span><span class="p">,</span> 
                        <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># point plot
</span>        <span class="k">if</span> <span class="n">kind</span><span class="o">==</span><span class="s">'point'</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                          <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">city_name</span><span class="p">,</span> 
                          <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">city_name</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">city_nb_high_price_gdf</span> <span class="o">=</span> <span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'num_listings &gt;= 10'</span><span class="p">)</span>
<span class="n">title</span><span class="o">=</span><span class="s">'Median Price for Neighbourhoods with &gt;= 10 listings'</span>
<span class="n">city_nb_cat_plot</span><span class="p">(</span><span class="n">city_nb_high_price_gdf</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'price_median'</span><span class="p">,</span>
                 <span class="n">kind</span><span class="o">=</span><span class="s">'point'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_41_0.png" alt="png" /></p>

<p>As observed in the map plots above, in all three cities downtown neighbourhoods were the most expensive. Here are the top and bottom 5 neighbourhood median prices by city.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># top 5 most expensive neighourhoods by city (with more than 10 reviews)
</span><span class="n">top_5_nb_price_df</span> <span class="o">=</span> <span class="n">city_nb_high_price_gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'city'</span><span class="p">)[</span><span class="s">'price_median'</span><span class="p">]</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">top_5_nb_price_df</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>city       neighbourhood            
portland   Pearl                        180.0
           Portland Downtown            169.0
           Northwest District           120.0
           Goose Hollow                 119.5
           Bridgeton                    119.0
seattle    Central Business District    285.0
           Pike-Market                  201.5
           International District       195.0
           Pioneer Square               187.5
           Briarcliff                   182.0
vancouver  Downtown                     121.5
           Downtown Eastside            114.0
           Kitsilano                    113.0
           Mount Pleasant               104.5
           West End                     101.0
Name: price_median, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># top 5 least expensive neighourhoods by city (with more than 10 reviews)
</span><span class="n">bot_5_nb_price_df</span> <span class="o">=</span> <span class="n">city_nb_high_price_gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'city'</span><span class="p">)[</span><span class="s">'price_median'</span><span class="p">]</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bot_5_nb_price_df</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>city       neighbourhood      
portland   Mill Park              44.0
           Centennial             45.0
           Hazelwood              50.0
           Lents                  50.0
           Parkrose               55.0
seattle    Meadowbrook            51.0
           Dunlap                 60.0
           High Point             65.0
           North College Park     65.0
           Pinehurst              65.0
vancouver  Renfrew-Collingwood    58.0
           Oakridge               61.0
           Victoria-Fraserview    65.0
           Killarney              68.5
           Marpole                69.0
Name: price_median, dtype: float64
</code></pre></div></div>

<h3 id="-conclusions-"><a name="conclusions1"> Conclusions </a></h3>

<p>We found that Portland has the least expensive listings while Seattle has the most expensive. As of November 2019, the median prices of listings (in USD) were Portland <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">$</mi><mn>90</mn></mrow><annotation encoding="application/x-tex">$90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">$</span><span class="mord">9</span><span class="mord">0</span></span></span></span>, Vancouver <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">$</mi><mn>95</mn></mrow><annotation encoding="application/x-tex">$95</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">$</span><span class="mord">9</span><span class="mord">5</span></span></span></span>, Seattle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">$</mi><mn>115</mn></mrow><annotation encoding="application/x-tex">$115</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">$</span><span class="mord">1</span><span class="mord">1</span><span class="mord">5</span></span></span></span>. We also found the 5 most and least expensive neighbourhoods for each city</p>

<h2 id="how-does-listing-price-change-over-time">How does listing price change over time?</h2>

<p>The listing prices in <code class="language-plaintext highlighter-rouge">listings</code> dataset represent the listing prices as of February 2019 when the data was gathered. To consider how prices change over time, we’ll need to look at the <code class="language-plaintext highlighter-rouge">calendar</code> dataset. It’s important to note that these represent the price to book listings for dates <em>in the future</em> (namely through February 2021) and are thus both subject to frequent change and distinct from actual (historical) prices paid for listings.</p>

<h3 id="what-trends-in-price-can-we-identify-across-all-three-cities">What trends in price can we identify across all three cities?</h3>

<p>Let’s look at yearly price trends. We’ll use mean instead of median here because it’s a bit smoother (perhaps because it’s less affected by listings going on and off the market, i.e. overall fluctations in availability).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calendar_line_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">agg_func</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">by_city</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                       <span class="n">rolling</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s">"""Plot line plot of aggregate function of price."""</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">calendar_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'date'</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rolling</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    
<span class="n">title</span> <span class="o">=</span> <span class="s">'Mean price of Cascadian Airbnb listings'</span>
<span class="n">calendar_line_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'price'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_51_0.png" alt="png" /></p>

<p>There is a clear short-term weekly trend, as well as a seasonal trend, neither of which is perhaps suprising. There are likely a number of factors influencing weekly demand fluctuations (for example increased influx of tourists) but understanding them is difficult given the data were working with.</p>

<p>Let’s look at a 14-day moving average to isolate the seasonal trend.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'14-day moving average mean price of Cascadian Airbnb listings'</span>
<span class="n">calendar_line_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'price'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span> 
                   <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_53_0.png" alt="png" /></p>

<p>There’s a clear trough around the winter holidays in 2021 followed by a plateau in January and February which is difficult to interpret. Minimum price is in March 2019, with maximum price reached in summer around the end of July and early August,  hypothetically caused by summer travel.</p>

<p>Let’s look at a plot of proportion of available listings, again taking a 14-day moving average to smooth out weekly fluctuations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'14-day moving average mean availability Cascadian Airbnb listings'</span>
<span class="n">calendar_line_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'available'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span>
                   <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_55_0.png" alt="png" /></p>

<p>There doesn’t seem to be any obvious relationship here between availability and price, although the year-long low in availability in January and February might have some relationship to the increase in price then.</p>

<h3 id="what-trends-in-price-can-we-identify-within-cities">What trends in price can we identify within cities?</h3>

<p>Let’s a look at whether these trends are similar across all three cities.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">city_ma_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">agg_func</span><span class="p">,</span>
                 <span class="n">rolling</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">calendar_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rolling</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s">'_7d_ma'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_func</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span> <span class="o">+</span> <span class="s">'_7d_ma'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s">'city'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s">'city'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p>First we’ll look at mean prices across cities</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Mean price of Cascadian Airbnb listings by city.'</span>
<span class="n">city_ma_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'price'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_61_0.png" alt="png" /></p>

<p>The price ranking we discovered <a href="#How-do-listing-prices-vary-across-the-cities?">above</a> (Portland &lt; Vancouver &lt; Seattle) is evident here.</p>

<p>The plots of median price by city show similar patterns to overall median – weekly price fluctuations and a steady increase reaching a maximum in late summer but there are some clear differences. The weekly price trend is much less pronounced in Vancouver than Seattle and Portland, while the summer price trend is much more pronounced in Seattle than Vancouver or Portland.</p>

<p>We note that Seattle and Portland prices both show the January-February 2021 increase we saw overall but Vancouver price does not.</p>

<p>Let’s look at 14-day moving average prices and availability</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'14-day moving average mean price of Cascadian Airbnb listings by city.'</span>
<span class="n">city_ma_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'price'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_63_0.png" alt="png" /></p>

<p>All three cities show the summer seasonal trends in price we identified above, although the summer trend is most pronounced in Seattle. The January-February 2021 price increase is most pronounced in Portland in fact at its peak it exceeds peak summer price by around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">$</mi><mn>10</mn></mrow><annotation encoding="application/x-tex">$10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">$</span><span class="mord">1</span><span class="mord">0</span></span></span></span> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>8</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">\approx 8\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.48312em;vertical-align:0em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">8</span><span class="mord">%</span></span></span></span>). During this time, Portland prices exceed Vancouver’s.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'14-day moving average availability of Cascadian Airbnb listings by city.'</span>
<span class="n">city_ma_plot</span><span class="p">(</span><span class="n">calendar_df</span><span class="p">,</span> <span class="s">'available'</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s">'mean'</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_65_0.png" alt="png" /></p>

<p>Availability trends are all remarkably similar across all three cities.</p>

<h3 id="-conclusions--1"><a name="conclusions2"> Conclusions </a></h3>

<p>The prices of listings in all three cities were lowest in March, and increasing throughout the year, peaking late summer. Relative to prices at other times of the year, this late summer increase is greatest for Seattle. Both Seattle and Portland see price increases in January and February of 2021, with Portlands price increase most pronounced (around 8% above peak summer prices).</p>

<p>Late summer is the most expensive time of year to visit all three cities (not suprising since it’s usual the longest stretch of warm dry weather in a region known for cold and wet), but since this seasonal price increase is much more pronounced for Seattle. If you want to visit the Pacific Northwest during late summer Vancouver and Portland look like more affordable options.</p>

<h2 id="how-does-overall-guest-satisfaction-relate-to-location">How does overall guest satisfaction relate to location?</h2>

<p>Now we’ll take a look at how guest satisfaction relates to location. We’ll use overall ratings of listings as a measure of guest satisfaction (<code class="language-plaintext highlighter-rouge">review_scores_rating</code>). The analysis will be very similar to what we did for price <a href="#Price">above</a></p>

<p>Let’s inspect overall ratings a little more carefully</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listings_df</span><span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>count    15979.000000
mean        95.574254
std          6.722625
min         20.000000
25%         94.000000
50%         98.000000
75%         99.000000
max        100.000000
Name: review_scores_rating, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="p">(</span><span class="n">listings_df</span><span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">/</span><span class="n">listings_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>\
<span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_73_0.png" alt="png" /></p>

<p>Again an extremely skewed distribution, highly concentrated in high rating values.</p>

<p>Since the value of <code class="language-plaintext highlighter-rouge">review_scores_rating</code> is an integer between 0 and 100, this variable presents an interesting modeling challenge (see <a href="#Predicting-overall-guest-satisfaction">below</a>). Thought of as a continuous variable, a reasonable parametric model for this variable might be the <a href="https://en.wikipedia.org/wiki/Beta_distribution">beta</a> distribution (or, for 100 - <code class="language-plaintext highlighter-rouge">review_scores_rating</code>, a <a href="https://en.wikipedia.org/wiki/Pareto_distribution#Bounded_Pareto_distribution">bounded Pareto</a> distribution).</p>

<p>A more appropriate model might be some thing along the lines of <a href="https://en.wikipedia.org/wiki/Ordered_logit">ordered logistic regression</a>, that is a latent 
variable model</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>i</mi><mo separator="true">,</mo><mn>0</mn><mo>⩽</mo><mi>i</mi><mo>⩽</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">Y = i,  0 \leqslant i \leqslant 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.79619em;vertical-align:-0.13667em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span></p>

<p>iff</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Y</mi><mo>∗</mo></msup><mo>∈</mo><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y^* \in [i, i+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.777796em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.738696em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>

<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span></span></span></span> is <code class="language-plaintext highlighter-rouge">review_scores_ratings</code> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>∗</mo></mrow><annotation encoding="application/x-tex">Y*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord">∗</span></span></span></span> is a latent continuous variable (perhaps beta or bounded Pareto distributed). This is an interesting area for further exploration, but we’re not going to go into it here. Later we’ll be focusing on <a href="#Modeling-response">prediction</a> and hence the conditional variable <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold">X</mi><mo>=</mo><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">Y| \mathbf{X} = \mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord">∣</span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span></span></span></span></p>

<h3 id="how-does-guest-satisfaction-compare-across-each-of-the-three-cities">How does guest satisfaction compare across each of the three cities?</h3>

<p>First we’d like to look at differences in listing prices between cities.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># boxen plots of ratings by city 
</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'city'</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxenplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'city'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s">'h'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Overall listing ratings by city'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_77_0.png" alt="png" /></p>

<p>The distributions appear quite similar. Unfortunately, standard Box-Cox transformations are of little use in spreading out the distribution for easier visual comparison.</p>

<p>Let’s look at summary statistics. As with price, we’ll use median for central tendency and median absolute deviation for spread.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># summary statistics of review_scores_rating
</span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'review_scores_rating'</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'mean'</span><span class="p">,</span> <span class="s">'std'</span><span class="p">])</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s">'median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'review_scores_rating'</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s">'mad'</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">listings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'city'</span><span class="p">])[</span><span class="s">'review_scores_rating'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'median'</span><span class="p">)</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>median</th>
      <th>mad</th>
    </tr>
    <tr>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>seattle</th>
      <td>6530.0</td>
      <td>20.0</td>
      <td>94.0</td>
      <td>97.0</td>
      <td>99.0</td>
      <td>100.0</td>
      <td>97</td>
      <td>2.9652</td>
    </tr>
    <tr>
      <th>vancouver</th>
      <td>5320.0</td>
      <td>20.0</td>
      <td>93.0</td>
      <td>97.0</td>
      <td>99.0</td>
      <td>100.0</td>
      <td>97</td>
      <td>4.4478</td>
    </tr>
    <tr>
      <th>portland</th>
      <td>4129.0</td>
      <td>20.0</td>
      <td>96.0</td>
      <td>98.0</td>
      <td>100.0</td>
      <td>100.0</td>
      <td>98</td>
      <td>2.9652</td>
    </tr>
  </tbody>
</table>
</div>

<p>While these numbers are very close, there are slight differences. Seattle and Vancouver have the same median rating of 97, and very similar distributions, while Portland has a higher median rating of 98. Seattle and Portland have comparable mads while Vancouver has a higher mad, indicating a wider spread.</p>

<h3 id="which-neighborhoods-have-the-highest-and-lowest-guest-satisfaction">Which neighborhoods have the highest and lowest guest satisfaction?</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">city_nb_ratings_gdf</span> <span class="o">=</span> <span class="n">get_city_nb_gdf</span><span class="p">(</span><span class="n">listings_df</span><span class="p">,</span> <span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">],</span> 
                                    <span class="n">num_reviews</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>geometry</th>
      <th>review_scores_rating_median</th>
      <th>review_scores_rating_mad</th>
      <th>num_reviews</th>
    </tr>
    <tr>
      <th>city</th>
      <th>neighbourhood</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">portland</th>
      <th>Alameda</th>
      <td>MULTIPOLYGON Z (((-122.64194 45.55542 0.00000,...</td>
      <td>99.0</td>
      <td>1.4826</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>Arbor Lodge</th>
      <td>MULTIPOLYGON Z (((-122.67858 45.57721 0.00000,...</td>
      <td>98.0</td>
      <td>1.4826</td>
      <td>71.0</td>
    </tr>
    <tr>
      <th>Argay</th>
      <td>MULTIPOLYGON Z (((-122.51026 45.56615 0.00000,...</td>
      <td>99.0</td>
      <td>1.4826</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>Arlington Heights</th>
      <td>MULTIPOLYGON Z (((-122.70194 45.52415 0.00000,...</td>
      <td>99.0</td>
      <td>1.4826</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Arnold Creek</th>
      <td>MULTIPOLYGON Z (((-122.69870 45.43255 0.00000,...</td>
      <td>99.0</td>
      <td>1.4826</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median ratings of Airbnb Listings for Portland neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'portland'</span><span class="p">],</span> <span class="s">'review_scores_rating_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Blues_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_83_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median rating of Airbnb Listings for Seattle neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'seattle'</span><span class="p">],</span> <span class="s">'review_scores_rating_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Oranges_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_84_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title</span> <span class="o">=</span> <span class="s">'Median rating of Airbnb Listings for Vancouver neighbourhoods.'</span>
<span class="n">city_nb_plot</span><span class="p">(</span><span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'vancouver'</span><span class="p">],</span> <span class="s">'review_scores_rating_median'</span><span class="p">,</span> 
             <span class="n">cmap</span><span class="o">=</span><span class="s">'Greens_r'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_85_0.png" alt="png" /></p>

<p>Compared to price, ratings don’t have as clear of a relationship to proximity to downtown. As with price, we want to be careful of neighbourhoods with small numbers of reviews. Now focusing on neighbourhoods with more than 10 reviews, we’ll plot the median rating so we can look at rankings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">city_nb_high_ratings_gdf</span> <span class="o">=</span> <span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'num_reviews &gt;= 10'</span><span class="p">)</span>
<span class="n">title</span><span class="o">=</span><span class="s">'Median Price for Listings with &gt;= 10 reviews'</span>
<span class="n">city_nb_cat_plot</span><span class="p">(</span><span class="n">city_nb_high_ratings_gdf</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'review_scores_rating_median'</span><span class="p">,</span>
                 <span class="n">kind</span><span class="o">=</span><span class="s">'point'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_87_0.png" alt="png" /></p>

<p>Here are the top and bottom 5 neighbourhoods by median ratings and city.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># top 5 most expensive neighourhoods by city (with more than 10 reviews)
</span><span class="n">city_nb_high_ratings_gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'city'</span><span class="p">)[</span><span class="s">'review_scores_rating_median'</span><span class="p">]</span>\
<span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>city       neighbourhood     
portland   West Portland Park    100.0
           Alameda                99.0
           Centennial             99.0
           Concordia              99.0
           Eastmoreland           99.0
seattle    Interbay              100.0
           Laurelhurst            99.5
           Crown Hill             99.0
           East Queen Anne        99.0
           Fairmount Park         99.0
vancouver  Mount Pleasant         98.0
           Riley Park             98.0
           Downtown               97.0
           Downtown Eastside      97.0
           Dunbar Southlands      97.0
Name: review_scores_rating_median, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># top 5 least expensive neighourhoods by city (with more than 10 reviews)
</span><span class="n">city_nb_high_ratings_gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'city'</span><span class="p">)[</span><span class="s">'review_scores_rating_median'</span><span class="p">]</span>\
<span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>city       neighbourhood            
portland   Hayhurst                     95.0
           Bridgeton                    96.0
           Mill Park                    96.0
           Old Town/Chinatown           96.0
           Powellhurst-Gilbert          96.0
seattle    International District       91.5
           Pioneer Square               92.0
           South Beacon Hill            93.5
           Central Business District    95.0
           Pinehurst                    95.0
vancouver  Killarney                    94.5
           Marpole                      95.0
           Shaughnessy                  95.0
           Victoria-Fraserview          95.0
           Arbutus Ridge                96.0
Name: review_scores_rating_median, dtype: float64
</code></pre></div></div>

<h3 id="how-does-the-price-of-listings-in-a-neighbourhood-relate-to-guest-satisfaction">How does the price of listings in a neighbourhood relate to guest satisfaction?</h3>

<p>Let’s look at a scatterplot of neighbourhood median price versus median rating.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">city_nb_price_gdf</span><span class="p">[</span><span class="s">'price_median'</span><span class="p">],</span> 
                <span class="n">city_nb_ratings_gdf</span><span class="p">[</span><span class="s">'review_scores_rating_median'</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'price_median'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'review_scores_rating_median'</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s">'city'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Neighbourhood median price vs. rating'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_93_0.png" alt="png" /></p>

<p>It’s hard to discern but the Seattle and Portland data seem to indicate a negative relationship between price and ratings, while Vancouver data indicates a positive relationship. To investigate this further, we’ll test two hypotheses.</p>

<p>The first (alternative) hypothesis is that there’s a linear relationship between neighbourhood median price and median rating - the test statistic is Pearson’s correlation coefficient. The first null hypothesis is that there’s no linear relationship between neighbourhood median price and median rating - the test statistic is Pearson’s correlation coefficient.</p>

<p>The second null hypothesis is that there’s no <a href="https://en.wikipedia.org/wiki/Rank_correlation">rank correlation</a> - the test statistic we’ll use <a href="https://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient">Spearman’s r</a>. This test has the advantage of being non-parametric, and detecting more general (non-linear) monotonic relationships. We’ll test the null hypothesis that price and rating have no monotic relationship.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_hyp_test_df</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s">'overall'</span><span class="p">):</span>
    <span class="s">"""Dataframe of row of hypothesis tests."""</span>
    <span class="n">hyp_test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'rho'</span><span class="p">,</span> <span class="s">'p_rho'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="s">'p_r'</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">index_label</span><span class="p">])</span>
    <span class="n">rho</span><span class="p">,</span> <span class="n">p_rho</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)</span>
    <span class="n">tau</span><span class="p">,</span> <span class="n">p_tau</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)</span>
    <span class="n">hyp_test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">,</span> <span class="s">'rho'</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span>
    <span class="n">hyp_test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">,</span> <span class="s">'p_rho'</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rho</span>
    <span class="n">hyp_test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">,</span> <span class="s">'r'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span>
    <span class="n">hyp_test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">,</span> <span class="s">'p_r'</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_tau</span>
    <span class="k">return</span> <span class="n">hyp_test_df</span>

<span class="k">def</span> <span class="nf">price_median_hyp_tests</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="p">):</span>
    <span class="s">"""Dataframe of hypothesis tests overalll and by city."""</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'rho'</span><span class="p">,</span> <span class="s">'p_rho'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="s">'p_r'</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">index_label</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'overall'</span><span class="p">,</span> <span class="s">'portland'</span><span class="p">,</span> <span class="s">'vancouver'</span><span class="p">,</span> <span class="s">'seattle'</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">index_label</span> <span class="o">==</span> <span class="s">'overall'</span><span class="p">:</span>
            <span class="n">hyp_test_df</span> <span class="o">=</span> <span class="n">get_hyp_test_df</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="p">[</span><span class="s">'price_median'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                          <span class="n">city_nb_ratings_gdf</span><span class="p">[</span><span class="s">'review_scores_rating_median'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                          <span class="n">index_label</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyp_test_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hyp_test_df</span> <span class="o">=</span> <span class="n">get_hyp_test_df</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">][</span><span class="s">'price_median'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                          <span class="n">city_nb_ratings_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_label</span><span class="p">][</span><span class="s">'review_scores_rating_median'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                          <span class="n">index_label</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyp_test_df</span><span class="p">)</span>
   
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># hypothesis tests for neighourhood median price and rating
</span><span class="n">price_median_hyp_tests</span><span class="p">(</span><span class="n">city_nb_price_gdf</span><span class="p">)</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rho</th>
      <th>p_rho</th>
      <th>r</th>
      <th>p_r</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>overall</th>
      <td>-0.350468</td>
      <td>1.96933e-07</td>
      <td>-0.117418</td>
      <td>0.0904213</td>
    </tr>
    <tr>
      <th>portland</th>
      <td>-0.273757</td>
      <td>0.00726562</td>
      <td>-0.137252</td>
      <td>0.184726</td>
    </tr>
    <tr>
      <th>vancouver</th>
      <td>0.588672</td>
      <td>0.00394961</td>
      <td>0.683055</td>
      <td>0.000459185</td>
    </tr>
    <tr>
      <th>seattle</th>
      <td>-0.450522</td>
      <td>6.59678e-06</td>
      <td>-0.127465</td>
      <td>0.225959</td>
    </tr>
  </tbody>
</table>
</div>

<p>For the tests for linear relationships, the sample pearson’s correlation indicates a weak negative relationship overall and for Portland, a moderately negative relationship for Seattle, and stronger positive relationship for Vancouver. The p-values for Portland and Vancouver are relatively high compared to Seattle however, and it’s clear the Seattle data had an outsize effect on the overall.</p>

<p>For the second test for more general monotic relationships, the sample spearman’s correlation indicates relationships in the same direction - negative overall and for Portland and Seattle, while positive for Vancouver. Here the p-values overall are quite high overall and for Portland and Seattle, high enough that the results aren’t significant and we won’t reject the null. The p-value for Vancouver is low enough to be significant however, in this case we will reject the null.</p>

<p>The results of the second test appear to be in conflict with the first, at least after hypothesis are accepted or rejected. Taking a more nuanced view, we’ll say there’s weak evidence of a negative relationship between price and rating overall and in Portland and Seattle, while there’s strong evidence of a positive relationship between price and rating in Vancouver.</p>

<h3 id="-conclusions--2"><a name="conclusions3"> Conclusions </a></h3>

<p>We found that Portland has the highest listings ratings. As of November 2019, the median ratings of listings were Portland 98, Vancouver 97, and Seattle 97. We also found the 5 highest and lowest rated neighbourhoods for each city.</p>

<p>We found weak evidence of a negative relationship between price and rating overall, and in Portland and Seattle, with Seattle showing the stronger relationship. We found strong evidence of a positive relationship between price and rating in Vancouver.</p>

<h2 id="what-are-the-most-important-listing-features-affecting-guest-satisfaction">What are the most important listing features affecting guest satisfaction?</h2>

<p>Now we’re interested in understanding how listing features relate to guest satisfaction, again using overll ratings as a measure of guest satisfaction.</p>

<p>We’ll treat this as a supervised learning problem with <code class="language-plaintext highlighter-rouge">review_scores_rating</code> as the response variable. We will also try to predict the response, although our main purpose is to get a sense of which features are most important in their relationship to guest satisfaction, rather than optimizing prediction accuracy.</p>

<h3 id="getting-features">Getting features</h3>

<p>Before we try to predict the overall rating response variable, we need to select features and inspect them and their relationship to the response. We’ll create a new dataframe with the features we want to focus on. We’ll also create a variable representing how long each host has been hosting.</p>

<p>Note that among other features, we are dropping <code class="language-plaintext highlighter-rouge">host_is_superhost</code>. Superhosts <a href="https://www.airbnb.com/help/article/829/how-do-i-become-a-superhost">by definition</a> have high overall ratings, so the presence of this feature has an outsize effect on the response (experiments not included here confirmed this).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_ratings_df</span><span class="p">(</span><span class="n">listings</span><span class="p">):</span>
    <span class="c1"># create a new variable representing how long each host has been a host
</span>    <span class="n">listings</span><span class="p">[</span><span class="s">'days_hosting'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'seattle'</span><span class="p">,</span> <span class="s">'days_hosting'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>\
                                              <span class="o">-</span> <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'seattle'</span><span class="p">][</span><span class="s">'host_since'</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">values</span>
    <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'portland'</span><span class="p">,</span> <span class="s">'days_hosting'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>\
                                               <span class="o">-</span> <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'portland'</span><span class="p">][</span><span class="s">'host_since'</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">values</span>
    <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'vancouver'</span><span class="p">,</span> <span class="s">'days_hosting'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>\
                                                <span class="o">-</span> <span class="n">listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'vancouver'</span><span class="p">][</span><span class="s">'host_since'</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">values</span>
    <span class="n">listings</span><span class="p">[</span><span class="s">'days_hosting'</span><span class="p">]</span> <span class="o">=</span> <span class="n">listings</span><span class="p">[</span><span class="s">'days_hosting'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int64'</span><span class="p">)</span>
    
    <span class="c1"># drop irrelevant columns 
</span>    <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'host_id'</span><span class="p">,</span> <span class="s">'host_identity_verified'</span><span class="p">,</span> <span class="s">'host_since'</span><span class="p">,</span>
                 <span class="s">'latitude'</span><span class="p">,</span> <span class="s">'longitude'</span><span class="p">,</span> <span class="s">'requires_license'</span><span class="p">,</span> 
                 <span class="s">'neighbourhood_cleansed'</span><span class="p">,</span> <span class="s">'host_is_superhost'</span><span class="p">,</span>
                 <span class="s">'maximum_nights'</span><span class="p">,</span> <span class="s">'minimum_nights'</span><span class="p">]</span>
    <span class="n">drop_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">listings</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s">'calculated'</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="n">drop_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">listings</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s">'calculated'</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> 
                  <span class="s">'availability'</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="n">drop_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">listings</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s">'review_score'</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="n">drop_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">'review_scores_rating'</span><span class="p">)</span>
    <span class="n">ratings_df</span> <span class="o">=</span> <span class="n">listings</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ratings_df</span>

<span class="n">ratings_df</span> <span class="o">=</span> <span class="n">create_ratings_df</span><span class="p">(</span><span class="n">listings_df</span><span class="p">)</span>
</code></pre></div></div>

<p>We’ll spend a little time getting to know these features.</p>

<h3 id="exploring-features">Exploring features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># get quantitative and categorical column names
</span><span class="n">quant_cols</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'int64'</span><span class="p">)</span> <span class="o">|</span> 
                                      <span class="p">(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'float64'</span><span class="p">)]</span>
<span class="n">cat_cols</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'bool'</span><span class="p">)</span> <span class="o">|</span> 
                                  <span class="p">(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'category'</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="n">quant_cols</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 15979 entries, ('seattle', 0) to ('vancouver', 6174)
Data columns (total 16 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   accommodates          15979 non-null  int64  
 1   bathrooms             15979 non-null  float64
 2   bedrooms              15979 non-null  int64  
 3   beds                  15979 non-null  int64  
 4   cleaning_fee          15979 non-null  float64
 5   extra_people          15979 non-null  float64
 6   guests_included       15979 non-null  int64  
 7   host_acceptance_rate  15979 non-null  float64
 8   host_response_rate    15979 non-null  float64
 9   num_amenities         15979 non-null  int64  
 10  number_of_reviews     15979 non-null  int64  
 11  price                 15979 non-null  float64
 12  review_scores_rating  15979 non-null  int64  
 13  reviews_per_month     15979 non-null  float64
 14  security_deposit      15979 non-null  float64
 15  days_hosting          15979 non-null  int64  
dtypes: float64(8), int64(8)
memory usage: 3.0+ MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 15979 entries, ('seattle', 0) to ('vancouver', 6174)
Data columns (total 58 columns):
 #   Column                            Non-Null Count  Dtype   
---  ------                            --------------  -----   
 0   amen_24_hour_checkin              15979 non-null  bool    
 1   amen_air_conditioning             15979 non-null  bool    
 2   amen_bathtub                      15979 non-null  bool    
 3   amen_bbq_grill                    15979 non-null  bool    
 4   amen_bed_linens                   15979 non-null  bool    
 5   amen_cable_tv                     15979 non-null  bool    
 6   amen_carbon_monoxide_detector     15979 non-null  bool    
 7   amen_childrens_books_and_toys     15979 non-null  bool    
 8   amen_coffee_maker                 15979 non-null  bool    
 9   amen_cooking_basics               15979 non-null  bool    
 10  amen_dishes_and_silverware        15979 non-null  bool    
 11  amen_dishwasher                   15979 non-null  bool    
 12  amen_dryer                        15979 non-null  bool    
 13  amen_elevator                     15979 non-null  bool    
 14  amen_extra_pillows_and_blankets   15979 non-null  bool    
 15  amen_family/kid_friendly          15979 non-null  bool    
 16  amen_fire_extinguisher            15979 non-null  bool    
 17  amen_first_aid_kit                15979 non-null  bool    
 18  amen_free_parking_on_premises     15979 non-null  bool    
 19  amen_free_street_parking          15979 non-null  bool    
 20  amen_garden_or_backyard           15979 non-null  bool    
 21  amen_gym                          15979 non-null  bool    
 22  amen_hair_dryer                   15979 non-null  bool    
 23  amen_hot_water                    15979 non-null  bool    
 24  amen_indoor_fireplace             15979 non-null  bool    
 25  amen_internet                     15979 non-null  bool    
 26  amen_iron                         15979 non-null  bool    
 27  amen_keypad                       15979 non-null  bool    
 28  amen_kitchen                      15979 non-null  bool    
 29  amen_laptop_friendly_workspace    15979 non-null  bool    
 30  amen_lock_on_bedroom_door         15979 non-null  bool    
 31  amen_lockbox                      15979 non-null  bool    
 32  amen_long_term_stays_allowed      15979 non-null  bool    
 33  amen_luggage_dropoff_allowed      15979 non-null  bool    
 34  amen_microwave                    15979 non-null  bool    
 35  amen_oven                         15979 non-null  bool    
 36  amen_pack-n-play_travel_crib      15979 non-null  bool    
 37  amen_patio_or_balcony             15979 non-null  bool    
 38  amen_pets_allowed                 15979 non-null  bool    
 39  amen_pets_live_on_this_property   15979 non-null  bool    
 40  amen_private_entrance             15979 non-null  bool    
 41  amen_private_living_room          15979 non-null  bool    
 42  amen_refrigerator                 15979 non-null  bool    
 43  amen_safety_card                  15979 non-null  bool    
 44  amen_self_check-in                15979 non-null  bool    
 45  amen_single_level_home            15979 non-null  bool    
 46  amen_stove                        15979 non-null  bool    
 47  amen_tv                           15979 non-null  bool    
 48  amen_washer                       15979 non-null  bool    
 49  bed_type                          15979 non-null  category
 50  cancellation_policy               15979 non-null  category
 51  host_response_time                15979 non-null  category
 52  instant_bookable                  15979 non-null  bool    
 53  is_business_travel_ready          15979 non-null  bool    
 54  property_type                     15979 non-null  category
 55  require_guest_phone_verification  15979 non-null  bool    
 56  require_guest_profile_picture     15979 non-null  bool    
 57  room_type                         15979 non-null  category
dtypes: bool(53), category(5)
memory usage: 1.9+ MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_dists</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">var_kind</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">trans_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
               <span class="n">dist_plot_kws</span><span class="o">=</span><span class="p">{},</span> <span class="n">count_plot_kws</span><span class="o">=</span><span class="p">{}):</span>

    <span class="n">ratings_df_cp</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">trans_dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trans_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ratings_df_cp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings_df_cp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">trans_dict</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_kind</span> <span class="o">==</span> <span class="s">'quants'</span><span class="p">:</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="n">num_cols</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">ratings_df_cp</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">dist_plot_kws</span><span class="p">)</span>
            
        
    <span class="k">if</span> <span class="n">var_kind</span> <span class="o">==</span> <span class="s">'cats'</span><span class="p">:</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="n">num_cols</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">ratings_df_cp</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">count_plot_kws</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span> 
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot of distributions of quantitative features
</span><span class="n">plot_dists</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'quants'</span><span class="p">,</span> <span class="n">quant_cols</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_111_0.png" alt="png" /></p>

<p>Most of these features are highly skewed and peaked, which could be problematic for prediction. Let’s apply a few Box-cox transformations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># minimum values for quantitative columns
</span><span class="n">ratings_df</span><span class="p">[</span><span class="n">quant_cols</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>accommodates             1.00
bathrooms                0.00
bedrooms                 0.00
beds                     0.00
cleaning_fee             0.00
extra_people             0.00
guests_included          1.00
host_acceptance_rate     0.00
host_response_rate       0.00
num_amenities            0.00
number_of_reviews        1.00
price                   10.00
review_scores_rating    20.00
reviews_per_month        0.01
security_deposit         0.00
days_hosting            13.00
dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot of distributions of transformed quantitative features
</span><span class="n">log_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'accommodates'</span><span class="p">,</span> <span class="s">'guests_included'</span><span class="p">,</span>
                                    <span class="s">'number_of_reviews'</span><span class="p">,</span> <span class="s">'price'</span><span class="p">,</span>
                                    <span class="s">'reviews_per_month'</span><span class="p">]}</span>
<span class="n">sqrt_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'bathrooms'</span><span class="p">,</span> <span class="s">'bedrooms'</span><span class="p">,</span>
                                      <span class="s">'beds'</span><span class="p">,</span> <span class="s">'cleaning_fee'</span><span class="p">,</span>
                                      <span class="s">'extra_people'</span><span class="p">,</span> <span class="s">'host_response_rate'</span><span class="p">,</span>
                                      <span class="s">'host_acceptance_rate'</span><span class="p">,</span>
                                      <span class="s">'security_deposit'</span><span class="p">]}</span>
<span class="n">trans_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">log_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">sqrt_dict</span><span class="p">}</span>
<span class="n">plot_dists</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'quants'</span><span class="p">,</span> <span class="n">quant_cols</span><span class="p">,</span> <span class="n">trans_dict</span><span class="o">=</span><span class="n">trans_dict</span><span class="p">,</span> 
           <span class="n">num_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_114_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># distributions of amenities variables
</span><span class="n">plot_dists</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">51</span><span class="p">],</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_115_0.png" alt="png" /></p>

<p>The amenities variables are not too badly unbalanced.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># distributions of other categorical variables
</span><span class="n">plot_dists</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">[</span><span class="mi">52</span><span class="p">:],</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_117_0.png" alt="png" /></p>

<p>Lets look at value counts of categorical variables which had values that didn’t show up in the count plots:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="s">'bed_type'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Real Bed         15828
Futon               73
Pull-out Sofa       55
Airbed              17
Couch                6
Name: bed_type, dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="s">'cancellation_policy'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strict_14_with_grace_period    6899
moderate                       6190
flexible                       2690
strict                          110
super_strict_30                  51
super_strict_60                  39
Name: cancellation_policy, dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="s">'host_response_time'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>within an hour        13657
within a few hours     1524
within a day            798
a few days of more        0
Name: host_response_time, dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span><span class="p">[</span><span class="s">'is_business_travel_ready'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>False    15979
Name: is_business_travel_ready, dtype: int64
</code></pre></div></div>

<p>We’ll drop <code class="language-plaintext highlighter-rouge">is_business_travel_ready</code> since it only has one value, but leave the other features untouched for now (even though they’re very unbalanced)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'is_business_travel_ready'</span><span class="p">])</span>
<span class="n">cat_cols</span> <span class="o">=</span> <span class="n">cat_cols</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'is_business_travel_ready'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="exploring-features-vs-response">Exploring features vs. response</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">var_kind</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span>
                     <span class="n">trans_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">scatter_plot_kws</span><span class="o">=</span><span class="p">{},</span> 
                     <span class="n">violin_plot_kws</span><span class="o">=</span><span class="p">{}):</span>
    
    <span class="n">ratings_df_cp</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">trans_dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trans_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ratings_df_cp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings_df_cp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">trans_dict</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">var_kind</span> <span class="o">==</span> <span class="s">'quants'</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ratings_df_cp</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="n">num_cols</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_plot_kws</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">var_kind</span> <span class="o">==</span> <span class="s">'cats'</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">cat_cols</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[(</span><span class="n">ratings_df_cp</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'bool'</span><span class="p">)</span> <span class="o">|</span> 
                                      <span class="p">(</span><span class="n">ratings_df_cp</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s">'category'</span><span class="p">)]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="n">num_cols</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ratings_df_cp</span><span class="p">,</span>
                           <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">violin_plot_kws</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>    
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot quantitative features vs. response.
</span><span class="n">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'review_scores_rating'</span><span class="p">,</span> <span class="s">'quants'</span><span class="p">,</span> <span class="n">quant_cols</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                 <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">scatter_plot_kws</span><span class="o">=</span><span class="p">{</span><span class="s">'alpha'</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">})</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_127_0.png" alt="png" /></p>

<p>It’s not hard to see the distribution of <code class="language-plaintext highlighter-rouge">review_scores_rating</code> reflected in some these scatterplots. For most of these features, there appears to be a positive relationship with the response (i.e., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">(</mo><mi>Y</mi><mi mathvariant="normal">∣</mi><mi>X</mi><mo>=</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}(Y|X = x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbb">E</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span> increases as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span> increases) but the relationship appears to be non-linear. It is interesting to note that <code class="language-plaintext highlighter-rouge">host_response_rate</code>and <code class="language-plaintext highlighter-rouge">host_acceptance_rate</code> seem to have a negative relationship to the response – higher response or acceptance rate doesn’t seem to be associated to higher rating, and some hosts with zero response or acceptance rate recieved high ratings.</p>

<p>Some of these scatterplots are highly concentrated – let’s look at scatterplots with the Box-Cox transformed quantitative variables.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot Box-Cox transformed features vs. response
</span><span class="n">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'review_scores_rating'</span><span class="p">,</span> <span class="s">'quants'</span><span class="p">,</span> <span class="n">quant_cols</span><span class="p">,</span> 
                 <span class="n">num_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trans_dict</span><span class="o">=</span><span class="n">trans_dict</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                 <span class="n">scatter_plot_kws</span><span class="o">=</span><span class="p">{</span><span class="s">'alpha'</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">})</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_129_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot first half of amenities features vs. response.
</span><span class="n">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'review_scores_rating'</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">25</span><span class="p">],</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_130_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot second half of amenities features vs. response.
</span><span class="n">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'review_scores_rating'</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">51</span><span class="p">],</span> 
                 <span class="n">num_rows</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_131_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot other categorical features vs. response.
</span><span class="n">plot_vs_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="s">'review_scores_rating'</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">[</span><span class="mi">51</span><span class="p">:],</span> 
                 <span class="n">num_rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_132_0.png" alt="png" /></p>

<h3 id="prediction">Prediction</h3>

<p>As mentioned <a href="#How-does-guest-satisfaction-relate-to-location?">previously</a>, the fact that ratings are integers in the range 0-100 makes them an <a href="http://rikunert.com/ordinal_rating">interesting modeling challenge</a>. Ratings are ordered, so not really categorical, but also discrete, hence not continuous – they are sometimes called <a href="http://users.stat.ufl.edu/~aa/ordinal/agresti_ordinal_tutorial.pdf">‘ordered categorical’</a>. Various techniques exist for modeling ordinal categorical data, one that seems to be common is <a href="https://en.wikipedia.org/wiki/Ordinal_regression">ordinal regression</a>.</p>

<p>In our case, treating ratings as classes of a categorical variable is problematic. Because not all possible rating values are present in the dataset, any classification algorithm will be unable to learn the missing classes, making generalization difficult. With that in mind, we’ll treat prediction of ratings as a regression problem.</p>

<h4 id="scikit-learn-regressors-on-original-features"><code class="language-plaintext highlighter-rouge">scikit-learn</code> regressors on original features</h4>

<p>First we’ll consider a handful of off-the-shelf scikit-learn regressors. We’ll consider <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> as a measure of goodness-of-fit, and <a href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.f1_score.html#sklearn.metrics.f1_score">mean absolute error</a> as a measure of prediction accuracy. We’ll use 5-fold cross validation to estimate these measures on train and test sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">features_and_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">trans_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="s">"""Create train and test data."""</span>
    <span class="c1"># features 
</span>    <span class="n">quant_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">])</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s">'number'</span><span class="p">)</span>
    
    <span class="c1"># apply transformations if present
</span>    <span class="k">if</span> <span class="n">trans_dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trans_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quant_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">trans_dict</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="c1"># min max scale quantitative
</span>    <span class="n">quant_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">quant_df</span> <span class="o">-</span> <span class="n">quant_df</span><span class="o">.</span><span class="nb">min</span><span class="p">())</span><span class="o">/</span>\
               <span class="p">(</span><span class="n">quant_df</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">quant_df</span><span class="o">.</span><span class="nb">min</span><span class="p">())</span>
    
    <span class="c1"># one hot encode categorical
</span>    <span class="n">cat_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s">'bool'</span><span class="p">,</span> <span class="s">'category'</span><span class="p">])</span>
    <span class="n">cat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">cat_df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cat_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1"># train test split
</span>    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">quant_df</span><span class="p">,</span> <span class="n">cat_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s">'review_scores_rating'</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># get feature and response
</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">features_and_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cv_score_ests</span><span class="p">(</span><span class="n">ests</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv_params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="s">"""Fit and score regression estimators."""</span>
   
    <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">est</span><span class="p">:</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">ests</span><span class="p">}</span>
            
    <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">ests</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Now cross-validating {est}:"</span><span class="p">)</span>
        
        <span class="c1"># cross-validate
</span>        <span class="n">scores</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">ests</span><span class="p">[</span><span class="n">est</span><span class="p">],</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="p">(</span><span class="s">'r2'</span><span class="p">,</span> <span class="s">'neg_mean_absolute_error'</span><span class="p">),</span>
                                     <span class="n">return_train_score</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">cv_params</span><span class="p">)</span>
        <span class="c1"># total fit and score times
</span>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"</span><span class="se">\t</span><span class="s">Total fit time {scores[est]['fit_time'].sum()} seconds"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"</span><span class="se">\t</span><span class="s">Total score time {scores[est]['score_time'].sum()} seconds"</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">scores</span>

<span class="k">def</span> <span class="nf">get_scores_df</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="s">"""Convert cross_validation score results to dataframe."""</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'train_r2_cv'</span><span class="p">,</span> <span class="s">'test_r2_cv'</span><span class="p">,</span> 
                                      <span class="s">'train_mae_cv'</span><span class="p">,</span> <span class="s">'test_mae_cv'</span><span class="p">],</span> 
                          <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'train_r2_cv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'train_r2'</span><span class="p">])</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'train_mae_cv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">scores</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'train_neg_mean_absolute_error'</span><span class="p">])</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'test_r2_cv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'test_r2'</span><span class="p">])</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'test_mae_cv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">scores</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="s">'test_neg_mean_absolute_error'</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">scores_df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cross-validation scores for sklearn regressors
</span><span class="n">random_state</span><span class="o">=</span> <span class="mi">27</span>
<span class="n">skl_reg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'dummy_reg'</span><span class="p">,</span> <span class="s">'rf_reg'</span><span class="p">,</span> <span class="s">'knn_reg'</span><span class="p">,</span> <span class="s">'svm_reg'</span><span class="p">,</span> <span class="s">'mlp_reg'</span><span class="p">]</span>
<span class="n">skl_reg_ests</span> <span class="o">=</span> <span class="p">[</span><span class="n">DummyRegressor</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s">'quantile'</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
                <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">),</span>
                <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">SVR</span><span class="p">(),</span>
                <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">)]</span>
<span class="n">skl_regs</span> <span class="o">=</span> <span class="p">{</span><span class="n">skl_name</span><span class="p">:</span> <span class="n">skl_est</span> <span class="k">for</span> <span class="p">(</span><span class="n">skl_name</span><span class="p">,</span> <span class="n">skl_est</span><span class="p">)</span> 
                 <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">skl_reg_names</span><span class="p">,</span> <span class="n">skl_reg_ests</span><span class="p">)}</span>
<span class="n">skl_cv_scores</span> <span class="o">=</span> <span class="n">cv_score_ests</span><span class="p">(</span><span class="n">skl_regs</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Now cross-validating dummy_reg:
	Total fit time 0.08077192306518555 seconds
	Total score time 0.00862574577331543 seconds
Now cross-validating rf_reg:
	Total fit time 188.30176401138306 seconds
	Total score time 0.2575101852416992 seconds
Now cross-validating knn_reg:
	Total fit time 3.506889581680298 seconds
	Total score time 91.79355835914612 seconds
Now cross-validating svm_reg:
	Total fit time 387.5005967617035 seconds
	Total score time 85.60344934463501 seconds
Now cross-validating mlp_reg:
	Total fit time 927.8406467437744 seconds
	Total score time 0.24310827255249023 seconds
</code></pre></div></div>

<h4 id="xgboost-regressors-on-original-features"><code class="language-plaintext highlighter-rouge">xgboost</code> regressors on original features.</h4>

<p>We’ll also try a few <code class="language-plaintext highlighter-rouge">xgboost</code> regressors.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cross-validation scores for xgb regressors
</span><span class="n">xgb_regs</span> <span class="o">=</span> <span class="p">{</span><span class="s">'xgb_reg_gbtree'</span><span class="p">:</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s">'reg:squarederror'</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                                           <span class="n">booster</span><span class="o">=</span><span class="s">'gbtree'</span><span class="p">),</span>
        <span class="s">'xgb_reg_dart'</span><span class="p">:</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s">'reg:squarederror'</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                                     <span class="n">booster</span><span class="o">=</span><span class="s">'dart'</span><span class="p">),</span>
        <span class="s">'xgb_rf_reg'</span><span class="p">:</span> <span class="n">XGBRFRegressor</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s">'reg:squarederror'</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">),</span>        
       <span class="p">}</span>
<span class="n">xgb_cv_scores</span> <span class="o">=</span> <span class="n">cv_score_ests</span><span class="p">(</span><span class="n">xgb_regs</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Now cross-validating xgb_reg_gbtree:
	Total fit time 127.19547653198242 seconds
	Total score time 0.4192464351654053 seconds
Now cross-validating xgb_reg_dart:
	Total fit time 173.1870722770691 seconds
	Total score time 0.381619930267334 seconds
Now cross-validating xgb_rf_reg:
	Total fit time 60.614177227020264 seconds
	Total score time 0.3912167549133301 seconds
</code></pre></div></div>

<h4 id="scikit-learn-and-xgboost-regressors-on-transformed-quantitative-features"><code class="language-plaintext highlighter-rouge">scikit-learn</code> and <code class="language-plaintext highlighter-rouge">xgboost</code> regressors on transformed quantitative features</h4>

<p>Now we’ll train the same estimators with the Box-Cox transformations applied to the quantitative features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cross-validation scores for sklearn regressors on transformed quantitative features
</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span> <span class="o">=</span> <span class="n">features_and_response</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">trans_dict</span><span class="o">=</span><span class="n">trans_dict</span><span class="p">)</span>
<span class="n">skl_tr_cv_scores</span> <span class="o">=</span> <span class="n">cv_score_ests</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">skl_regs</span><span class="p">),</span> <span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Now cross-validating dummy_reg:
	Total fit time 0.22921514511108398 seconds
	Total score time 0.11698532104492188 seconds
Now cross-validating rf_reg:
	Total fit time 392.9649088382721 seconds
	Total score time 0.6730427742004395 seconds
Now cross-validating knn_reg:
	Total fit time 5.470238447189331 seconds
	Total score time 139.15924906730652 seconds
Now cross-validating svm_reg:
	Total fit time 383.95023369789124 seconds
	Total score time 88.58065724372864 seconds
Now cross-validating mlp_reg:
	Total fit time 2479.512115955353 seconds
	Total score time 0.6705708503723145 seconds
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cross-validation scores for xgboost regressors on transformed quantitative features
</span><span class="n">xgb_tr_cv_scores</span> <span class="o">=</span> <span class="n">cv_score_ests</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xgb_regs</span><span class="p">),</span> <span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Now cross-validating xgb_reg_gbtree:
	Total fit time 79.85912299156189 seconds
	Total score time 0.23249483108520508 seconds
Now cross-validating xgb_reg_dart:
	Total fit time 86.58256101608276 seconds
	Total score time 0.3087317943572998 seconds
Now cross-validating xgb_rf_reg:
	Total fit time 32.99137830734253 seconds
	Total score time 0.25188732147216797 seconds
</code></pre></div></div>

<h3 id="evaluation">Evaluation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># scores for regressors on original features
</span><span class="n">cv_scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">get_scores_df</span><span class="p">(</span><span class="n">skl_cv_scores</span><span class="p">),</span> 
                          <span class="n">get_scores_df</span><span class="p">(</span><span class="n">xgb_cv_scores</span><span class="p">)])</span>
<span class="n">cv_scores_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'test_mae_cv'</span><span class="p">)</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>train_r2_cv</th>
      <th>test_r2_cv</th>
      <th>train_mae_cv</th>
      <th>test_mae_cv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>svm_reg</th>
      <td>0.0989352</td>
      <td>0.0440145</td>
      <td>3.11877</td>
      <td>3.37781</td>
    </tr>
    <tr>
      <th>xgb_reg_gbtree</th>
      <td>0.283062</td>
      <td>0.090087</td>
      <td>3.36763</td>
      <td>3.61091</td>
    </tr>
    <tr>
      <th>xgb_reg_dart</th>
      <td>0.283062</td>
      <td>0.090087</td>
      <td>3.36763</td>
      <td>3.61091</td>
    </tr>
    <tr>
      <th>rf_reg</th>
      <td>0.872611</td>
      <td>0.0392426</td>
      <td>1.30534</td>
      <td>3.69346</td>
    </tr>
    <tr>
      <th>xgb_rf_reg</th>
      <td>0.0851254</td>
      <td>0.0172077</td>
      <td>3.80102</td>
      <td>3.8438</td>
    </tr>
    <tr>
      <th>knn_reg</th>
      <td>0.477698</td>
      <td>-0.196441</td>
      <td>2.68117</td>
      <td>4.10671</td>
    </tr>
    <tr>
      <th>dummy_reg</th>
      <td>-0.435698</td>
      <td>-0.487574</td>
      <td>4.42575</td>
      <td>4.42581</td>
    </tr>
    <tr>
      <th>mlp_reg</th>
      <td>0.482781</td>
      <td>-0.337821</td>
      <td>3.0869</td>
      <td>4.58315</td>
    </tr>
  </tbody>
</table>
</div>

<p>The support vector regressor achieved the lowest MAE, but with a very low <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> on both train and test. However, in this case MAE and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> are both similar on train and test, indicating a low chance of overfitting. Decision trees and random forest regressors were next best, and appear to be overfitting giving the differences between train and test performance.</p>

<p>The dummy regressor, which predicts the 0.8 quantile, achieves the worst MAE of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>4.64</mn></mrow><annotation encoding="application/x-tex">\approx 4.64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.48312em;vertical-align:0em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span><span class="mord">.</span><span class="mord">6</span><span class="mord">4</span></span></span></span>. The <code class="language-plaintext highlighter-rouge">xgboost</code> MAE scores have a good balance between train and test MAE (hence lower chance of overfitting).</p>

<p>The random forest regressor has a very high train <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> relative to the others, while its test <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> is comparable to the <code class="language-plaintext highlighter-rouge">xgboost</code> decision trees, which have a better train-test balance.  K-nearest neighbors, dummy and neural network regressors all have negative test <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>.</p>

<p>Now let’s take a look at performance of the same estimators with the transformed quantitative features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># scores for regressors on transformed quantitative features
</span><span class="n">cv_tr_scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">get_scores_df</span><span class="p">(</span><span class="n">skl_tr_cv_scores</span><span class="p">),</span> 
                             <span class="n">get_scores_df</span><span class="p">(</span><span class="n">xgb_tr_cv_scores</span><span class="p">)])</span>
<span class="n">cv_tr_scores_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'test_mae_cv'</span><span class="p">)</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>train_r2_cv</th>
      <th>test_r2_cv</th>
      <th>train_mae_cv</th>
      <th>test_mae_cv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>svm_reg</th>
      <td>0.0705476</td>
      <td>0.0123341</td>
      <td>3.05736</td>
      <td>3.32316</td>
    </tr>
    <tr>
      <th>xgb_reg_gbtree</th>
      <td>0.283062</td>
      <td>0.0900792</td>
      <td>3.36763</td>
      <td>3.61099</td>
    </tr>
    <tr>
      <th>xgb_reg_dart</th>
      <td>0.283062</td>
      <td>0.0900792</td>
      <td>3.36763</td>
      <td>3.61099</td>
    </tr>
    <tr>
      <th>rf_reg</th>
      <td>0.872989</td>
      <td>0.0422299</td>
      <td>1.30385</td>
      <td>3.69028</td>
    </tr>
    <tr>
      <th>xgb_rf_reg</th>
      <td>0.0851254</td>
      <td>0.0172077</td>
      <td>3.80102</td>
      <td>3.8438</td>
    </tr>
    <tr>
      <th>knn_reg</th>
      <td>0.486047</td>
      <td>-0.145304</td>
      <td>2.64827</td>
      <td>4.02214</td>
    </tr>
    <tr>
      <th>dummy_reg</th>
      <td>-0.435698</td>
      <td>-0.487574</td>
      <td>4.42575</td>
      <td>4.42581</td>
    </tr>
    <tr>
      <th>mlp_reg</th>
      <td>0.588182</td>
      <td>-0.506876</td>
      <td>2.70681</td>
      <td>4.5025</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># change in measures after transforming quantitative features
</span><span class="n">cv_tr_scores_df</span> <span class="o">-</span> <span class="n">cv_scores_df</span>
</code></pre></div></div>

<div>
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>train_r2_cv</th>
      <th>test_r2_cv</th>
      <th>train_mae_cv</th>
      <th>test_mae_cv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dummy_reg</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>rf_reg</th>
      <td>0.000377536</td>
      <td>0.00298736</td>
      <td>-0.00148491</td>
      <td>-0.0031827</td>
    </tr>
    <tr>
      <th>knn_reg</th>
      <td>0.00834828</td>
      <td>0.0511373</td>
      <td>-0.0329024</td>
      <td>-0.0845673</td>
    </tr>
    <tr>
      <th>svm_reg</th>
      <td>-0.0283876</td>
      <td>-0.0316803</td>
      <td>-0.0614091</td>
      <td>-0.0546447</td>
    </tr>
    <tr>
      <th>mlp_reg</th>
      <td>0.105401</td>
      <td>-0.169055</td>
      <td>-0.380083</td>
      <td>-0.0806514</td>
    </tr>
    <tr>
      <th>xgb_reg_gbtree</th>
      <td>0</td>
      <td>-7.86682e-06</td>
      <td>0</td>
      <td>7.53022e-05</td>
    </tr>
    <tr>
      <th>xgb_reg_dart</th>
      <td>0</td>
      <td>-7.86682e-06</td>
      <td>0</td>
      <td>7.53022e-05</td>
    </tr>
    <tr>
      <th>xgb_rf_reg</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<p>There’s a slight performance improvement for all the <code class="language-plaintext highlighter-rouge">scikit-learn</code> regressors except the dummy regressor when fit with the transformed quantitative features.</p>

<h3 id="interpretation">Interpretation</h3>

<p>Our main purpose was to get a sense of which features are most important. 
Tree-based models performed fairly well relative to other models, and have the benefit of being relatively straightforward to interpret, so we’ll focus on these models.
Specifically, we’ll look at the <code class="language-plaintext highlighter-rouge">scikit-learn</code> random forest regressor and the <code class="language-plaintext highlighter-rouge">xgboost</code> dart and gradient boosted regressor fit on the transformed features.</p>

<p>Let’s visualize their feature importances.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_feature_importances</span><span class="p">(</span><span class="n">tree_ests</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)):</span>
    <span class="s">"""Plot top feature importances for tree-based estimators."""</span>
    <span class="c1"># set of importances
</span>    <span class="n">importances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">est</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_ests</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'importance'</span><span class="p">:</span> <span class="n">tree_ests</span><span class="p">[</span><span class="n">est</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">},</span> 
                          <span class="n">index</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">'importance'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">est</span> <span class="o">+</span> <span class="n">f</span><span class="s">' top {num_features} feature importances'</span><span class="p">)</span>
        <span class="c1"># track importances
</span>        <span class="n">importances</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">importances</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fit tree estimators
</span><span class="n">tree_ests</span> <span class="o">=</span> <span class="p">{</span><span class="s">'rf_reg'</span><span class="p">:</span> <span class="n">skl_regs</span><span class="p">[</span><span class="s">'rf_reg'</span><span class="p">],</span> <span class="s">'xgb_reg_gbtree'</span><span class="p">:</span> <span class="n">xgb_regs</span><span class="p">[</span><span class="s">'xgb_reg_gbtree'</span><span class="p">]}</span>
<span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">tree_ests</span><span class="p">:</span>
    <span class="n">tree_ests</span><span class="p">[</span><span class="n">est</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot feature importances
</span><span class="n">top_30_importances</span> <span class="o">=</span> <span class="n">plot_feature_importances</span><span class="p">(</span><span class="n">tree_ests</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                              <span class="n">num_features</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/cascadia_airbnb/assets/images/analysis-and-modeling_158_0.png" alt="png" /></p>

<p>There is some clear difference between the features here. The <code class="language-plaintext highlighter-rouge">xgboost</code> decision tree estimator has really favored the amenities features.</p>

<p>Common sense suggests the <code class="language-plaintext highlighter-rouge">xgboost</code> estimator has learned less meaningful associations to the response (e.g. the presence of a coffee maker, or the fact that a guest profile picture is required).</p>

<p>In the interest of our goal of interpretatibility then, we’ll select the <code class="language-plaintext highlighter-rouge">sklearn</code> random forest model as our final model.</p>

<h3 id="model-improvement">Model Improvement</h3>

<p>So far our best prediction performance, as measured by cv estimate of test MAE, was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>3.5</mn></mrow><annotation encoding="application/x-tex">\approx 3.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.48312em;vertical-align:0em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">.</span><span class="mord">5</span></span></span></span> for the support vector machine. For the sake of interpretability, we selected the random forest model with cv estimate of test mae of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>3.8</mn></mrow><annotation encoding="application/x-tex">\approx 3.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.48312em;vertical-align:0em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">.</span><span class="mord">8</span></span></span></span>, which had a very high cv train <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> estimate relative to the other models.</p>

<p>All models had abysmal <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> however, suggesting plenty of room for improvement. Some possibilites to explore to improve model fit and prediction performance:</p>

<p>(1) Hyperparameter tuning</p>

<p>(2) Further feature transformation, selection and engineering, including revisiting the original dataset, or including new features. One promising option might be natural language processing on some of the string features in <code class="language-plaintext highlighter-rouge">listings</code> dataset (e.g. <code class="language-plaintext highlighter-rouge">description</code>) or on actual reviews (full text reviews for listings are available at <a href="http://insideairbnb.com/get-the-data.html">InsideAirbnb</a>.</p>

<p>(3) Ensemble methods for combining estimators.</p>

<p>(4) Finding models better suited to the range and distribution of the response (e.g. other ordinal regression models such as <a href="https://www.ime.usp.br/~sferrari/beta.pdf">beta regression</a>).</p>

<p>We may explore these options in the future but for now we’ve met our goal of finding a predictive model which can help us get a sense of which features are most closely related to guest satisfaction.</p>

<h3 id="-conclusions--3"><a name="conclusions4"> Conclusions </a></h3>

<p>Based on the random forest model, the top 10 most important features are</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">top_30_importances</span><span class="p">[</span><span class="s">'rf_reg'</span><span class="p">])[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0         reviews_per_month
1                     price
2         number_of_reviews
3              days_hosting
4             num_amenities
5        host_response_rate
6              cleaning_fee
7    amen_coffee_maker_True
8      host_acceptance_rate
9          security_deposit
dtype: object
</code></pre></div></div>

<p>None of these are perhaps too surprising (except maybe the presence of a coffee maker!).  It’s interesting to note the presence of <code class="language-plaintext highlighter-rouge">host_response_rate</code> and <code class="language-plaintext highlighter-rouge">host_acceptance_rate</code> among the top feature importances. We noted <a href="#Exploring-features-vs.-response">above</a> a somewhat suprising negative assocation with the response, and their presence here is one possible indication of the strength of that relationship.</p>

<p>We can speculate a bit about why these feature associations are ranked highly.</p>

<p>Reviews per month and number of reviews seem reasonable – listings with higher reviews may be more frequently booked and hence more frequently reviewed. Price, cleaning fee and security deposit may have association to quality factors such as value of property (as well as to each other). Days hosting or number of amenities might be associated to positive guest experience.</p>

<p>Further investigation of these assocations can help shed light on these speculations.</p>


</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', functione. {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
